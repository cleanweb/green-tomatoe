<doctype html>
<head>
	<link rel="stylesheet" href="/static/css/bootstrap-1.2.0.min.css">
	<style type="text/css">
		body{
			margin: auto auto;
			width:940px;
		}
	</style>
	
	<script type="text/javascript" src="/static/js/jquery.js"></script>
	<script type="text/javascript" src="/static/js/json2.js"></script>
	<script type="text/javascript" src="/static/js/underscore.js"></script>
	<script type="text/javascript" src="/static/js/backbone.js"></script>
	<script type="text/javascript" src="/static/js/tomatoe.js"></script>
	
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script type="text/javascript" src="/static/js/charts.js"></script>
</head>
<body>
  
  <div class="topbar">
      <div class="topbar-inner">
        <div class="container">
          <h3><a href="#">Tomatoe</a></h3>
          <ul class="nav">
            <li class="active"><a href="#">Home</a></li>
          </ul>
        </div>
      </div><!-- /topbar-inner -->
    </div>
  
  <div class="row show-grid" style="margin-top: 50px;">
    <div class="span5 columns">
    	<ul>
    		<li>All states 
	      			<a class="allstates-selector-add" data-state="ALL" href="#">+</a>
	      			<a class="allstates-selector-remove" style="display:none;" data-state="ALL" href="#">-</a>
	      		</li>
	      	{% for state in states %}
	      		<li data-state="{{state.code}}">{{state.name}} 
	      			<a class="state-selector-add" data-state="{{state.code}}" href="#">+</a>
	      			<a class="state-selector-remove" style="display:none;" data-state="{{state.code}}" href="#">-</a>
	      		</li>
	      	{% endfor %}
      	</ul>
    </div>
    <div id="content" class="span11 columns">
    	
    	<h2>Asian population VS food sales</h2>
    	
    	<div class="well" style="padding: 14px 19px;">
        	<button data-perspective="table" class="btn change-persective">Table</button>&nbsp;
        	<button data-perspective="columns" class="btn change-persective">Columns</button>&nbsp;
        	<button data-perspective="pie" class="btn change-persective">Pie</button>&nbsp;
      		<button data-perspective="lines" class="btn change-persective">Lines</button>
      	</div>
    	
 		<div id="data-views">
 			<div id="table-wrapper"></div>	
 			<div id="columns-wrapper"></div>
 		</div>
 		
    </div>
  </div>
  
  
  <script type="text/template" id="template-data-views">
  	<ul class="tabs">
		  <% _.each(views, function(view) { %> 
		  	<li><a class="data-view-selector" data-view-id="<%= view.id %>" data-fields="<%= view.fields %>" href="#"><%= view.title %></a></li> 
		  <% }); %>
 	</ul>
  </script>
  
  <script type="text/template" id="template-table">
  	
  	<table class="zebra-striped">
      <thead>
 	    <tr>
		  <% _.each(columns, function(column) { %> 
		  	<th><%= column.title %></th> 
		  <% }); %>    
		</tr>
      </thead>
          
      <tbody>
        <% _.each(data, function(row) { %> 
		  	<tr>
		  	  <% _.each(row, function(col) { %>
		      	 <td><%= col %></td>
		      <% }); %>
		  	</tr> 
	    <% }); %>	          	          
	  </tbody>
      
    </table>
  	
  </script>
  
  
  <script type="text/javascript">
  	
  	google.load("visualization", "1", {packages:["corechart"]});
  	
  	//singletons
  	window.query = new Query;
  	window.dataSnapshotView = new DataSnaphotsView;
  	window.currentDataset = null;
  	window.currentPerspective = "table";
  	
  	$(document).ready(function(){
  		window.query.addField("population");
  	
  		function updateQuery() {
  			console.log("query changed");
  			console.log(this);
  			
  			if(!window.query.isComplete()){
  				$("#table-wrapper").html("<h3>No data to display</h3>");
  				return;
  			}
  			
  			var m = new Dataset;
  			m.set({query : window.query.toString() });
  		    m.fetch({
	  			success : function(model, response){
	  				window.currentDataset = response;
	  				
	  				model.set(response);	
	  				var tv = new TableView({model : model});
	  				$("#table-wrapper").html(tv.render());
	  				
	  			},
	  			error : function(model, response){
	  				console.log(response);
	  			}
  			});
  			
  		}
  	
  		//keep track of what data view is selected
  		window.dataSnapshotView.bind("selected-view-changed", function(){
  			console.log(this.selectedView.get("fields"));
  			
  			window.query.setFields(this.selectedView.get("fields"));
  		
  		}, window.dataSnapshotView);
  	
  		//monitor changes to the query object
  		window.query.bind('states-changed', function(){
  			updateQuery();
  		}, window.query);
  	
  		window.query.bind('fields-changed', function(){
  			updateQuery();
  		}, window.query);
  	
  		//** add state to the query 
  		$(".state-selector-add").click(function(){
  			
  			$(this).hide();
  			$(this).parent().children(".state-selector-remove").show();
  			$(".allstates-selector-add").show();
  			$(".allstates-selector-remove").hide();
  			
  			var code = $(this).attr("data-state");
  			window.query.addState(code);
  		});
  		
  		//** remove state from the query
  		$(".state-selector-remove").click(function(){
  			
  			$(this).hide();
  			$(this).parent().children(".state-selector-add").show();
  			$(".allstates-selector-add").show();
  			$(".allstates-selector-remove").hide();
  			
  			var code = $(this).attr("data-state");
  			window.query.removeState(code);
  		});
  		
  		//** add all states
  		$(".allstates-selector-add").click(function(){
  			
  			var states = [];
  			
  			$(this).hide();
  			$(this).parent().children(".allstates-selector-remove").show();
  			
  			$(this).parent().siblings().each(function(){
  				states.push($(this).attr("data-state"));
  				
  				$(this).children(".state-selector-remove").show();
  				$(this).children(".state-selector-add").hide();
  			});
  			
  			window.query.setStates(states);
  		});
  		
  		//** remove all states
  		$(".allstates-selector-remove").click(function(){
  			
  			$(this).hide();
  			$(this).parent().children(".allstates-selector-add").show();
  			
  			$(this).parent().siblings().each(function(){
  				$(this).children(".state-selector-add").show();
  				$(this).children(".state-selector-remove").hide();
  			});
  			
  			window.query.setStates([]);
  		});
  		
  		//** change data perspective
  		$(".change-persective").click(function(){
  			var btn = $(this);
  			var perspective = btn.attr("data-perspective"); 
  			
  			$("#data-views").children().hide();
  			
  			if(perspective == "table"){
  				var m = new Dataset
  				m.set(window.currentDataset);
  				var tv = new TableView({model : m});
	  			$("#" + perspective + "-wrapper").html(tv.render());
	  			$("#" + perspective + "-wrapper").show();		
  			}
  			
  			if(perspective == "columns"){
  				$("#" + perspective + "-wrapper").html("").show();
  				barChart(window.currentDataset, perspective + "-wrapper");
  			}
  			
  		});
  		
  		window.dataSnapshotView.selectDefaultView();
  		
  	});
  	
  </script>
  
</body>
